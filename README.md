
# é¢†åŸŸæ¨¡å‹å¤ªå¤æ‚æ€ä¹ˆç ´ï¼Ÿ

## èƒŒæ™¯

æŒ‰ç…§ DDD çš„è®¾è®¡æ€æƒ³ï¼Œè°ƒç”¨æ–¹ä»…èƒ½æ“ä½œ Aggregate Rootï¼Œè€Œä¸èƒ½å•ç‹¬é’ˆå¯¹æŸä¸ªé Aggregate Root çš„ Entity ç›´æ¥æ“ä½œã€‚ä½†æœ‰æ—¶å€™ä¸šåŠ¡æ¨¡å‹å°±æ˜¯å¾ˆå¤æ‚ï¼Œå¦‚æœæ‹†åˆ†æˆå¤šä¸ª Aggregateï¼Œç›¸äº’ä¹‹é—´çš„ä¾èµ–ä¼šè®©ä¸šåŠ¡é€»è¾‘çš„å®ç°å˜å¾—æ›´å¤æ‚ã€‚

## ä¸»æµæ–¹æ¡ˆ

æœ‰ä»€ä¹ˆåŠæ³•å‰Šå¼±å¤æ‚çš„ Aggregate äº§ç”Ÿçš„è´Ÿé¢å½±å“å‘¢ï¼Ÿå¸¸è§çš„ä¸»æµæ–¹æ¡ˆæ˜¯ **Change-Tracking** å˜åŒ–è¿½è¸ªï¼Œå¦‚æœèƒ½çŸ¥é“å“ªäº›å€¼å˜åŒ–äº†ï¼Œå°±åªéœ€è¦æ›´æ–°æœ‰å˜åŒ–çš„å€¼ã€‚å°±ä¸ä¼šå‡ºç°åªæ›´æ–°äº†ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œæ•´ä¸ª Aggregate ç›¸å…³çš„æ•°æ®æ¨¡å‹éƒ½æ›´æ–°äº†ä¸€éçš„å°´å°¬åœºæ™¯äº†ã€‚å¸¸è§çš„å®ç°æ–¹å¼æœ‰

##### 1ã€åŸºäºSnapshotçš„æ–¹æ¡ˆï¼š

å½“æ•°æ®ä»DBé‡Œå–å‡ºæ¥åï¼Œåœ¨å†…å­˜ä¸­ä¿å­˜ä¸€ä»½snapshotï¼Œç„¶ååœ¨æ•°æ®å†™å…¥æ—¶å’Œsnapshotæ¯”è¾ƒã€‚å¸¸è§çš„å®ç°å¦‚Hibernateã€‚

##### 2ã€åŸºäºProxyçš„æ–¹æ¡ˆï¼š

å½“æ•°æ®ä»DBé‡Œå–å‡ºæ¥åï¼Œé€šè¿‡weavingçš„æ–¹å¼å°†æ‰€æœ‰setteréƒ½å¢åŠ ä¸€ä¸ªåˆ‡é¢æ¥åˆ¤æ–­setteræ˜¯å¦è¢«è°ƒç”¨ä»¥åŠå€¼æ˜¯å¦å˜æ›´ï¼Œå¦‚æœå˜æ›´åˆ™æ ‡è®°ä¸ºDirtyã€‚åœ¨ä¿å­˜æ—¶æ ¹æ®Dirtyåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ã€‚å¸¸è§çš„å®ç°å¦‚Entity Frameworkã€‚



## æ–°çš„å®è·µ

ç°å®ä¸­çš„ Aggregate è™½ç„¶å¤æ‚ï¼Œä½†å­å®ä½“çš„æ›´æ–°å¹¶ä¸é¢‘ç¹ï¼Œå¤§æ¦‚ç‡æ˜¯èšåˆçš„çŠ¶æ€å˜æ›´ï¼Œå…¸å‹çš„ä¾‹å­å°±æ˜¯ç”µå•†çš„äº¤æ˜“ã€‚å¤§éƒ¨åˆ†åœºæ™¯åªéœ€è¦ç”¨åˆ°äº¤æ˜“ä¸»è¡¨çš„ä¿¡æ¯ï¼Œæˆ–åªéœ€è¦æ›´æ–°äº¤æ˜“çš„çŠ¶æ€ï¼Œä½†æ˜¯æ„é€  Aggregate æ—¶ä¼šæŠŠæ‰€æœ‰çš„é Aggregate Root çš„ Entity ä¹Ÿæ„é€ å‡ºæ¥ã€‚æ‰€ä»¥ä¸»æµæ–¹æ¡ˆç”¨åˆ°ç°åœ¨çš„äº¤æ˜“ç³»ç»Ÿä¸ä»…å®ç°æˆæœ¬è¾ƒé«˜ï¼Œè¿˜ä¸èƒ½è§£å†³æ‰€æœ‰çš„ç—›ç‚¹ã€‚ä½†å—åˆ°ä¸Šé¢æ–¹æ¡ˆçš„å¯å‘ï¼Œæƒ³åˆ°äº†ä¸€ç§æ›´è½»é‡çš„æ–¹æ¡ˆã€‚

#### LazyRead&Tracking

ä¸»è¦çš„æ€è·¯å°±æ˜¯åœ¨æ„é€  Aggregate æ—¶ï¼Œå¹¶ä¸ç›´æ¥æ„é€ æ‰€æœ‰çš„ Entity ï¼Œè€Œåªæ„é€ ä¸» Entity å¹¶æ„é€ å…¶ä»– Entity çš„æ”¹é€ æ–¹æ³•ï¼ˆğŸš«ç¦æ­¢å¥—å¨ƒï¼‰ã€‚ç„¶ååœ¨æŒä¹…åŒ–æ—¶åªå¤„ç†æ­£åœ¨æ„é€ è¿‡çš„å®ä½“ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ã€‚

- å¦‚ä½•å®ç°åœ¨ç”¨çš„æ—¶å€™æ‰æ„é€ å‘¢ï¼Ÿ
- é‡å¤è¯»å–çš„æ—¶å€™æ€ä¹ˆä¿è¯åªæ„é€ ä¸€æ¬¡å‘¢ï¼Ÿ
- æŒä¹…åŒ–çš„æ—¶å€™æ€ä¹ˆæ‰èƒ½æ„ŸçŸ¥åˆ°å“ªäº›å®ä½“æ˜¯æ„é€ è¿‡çš„å‘¢ï¼Ÿ
- æ–°åˆ›å»ºçš„å®ä½“æ€ä¹ˆåœ¨æŒä¹…åŒ–æ—¶æ­£ç¡®å¤„ç†å‘¢ï¼Ÿ

ç­”æ¡ˆå°±æ˜¯ **AwareSupplier**ï¼ˆç°ä»£ç å·²ç®€åŒ–ä¸º **As**ï¼‰ã€‚

```Java
public interface AwareSupplier<T> extends Supplier<T> {
    boolean isHere();
}
```

`AwareSupplier` ç»§æ‰¿è‡ª `Supplier`ã€‚ç›¸æ¯” `Supplier` å¤šå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³• `isHere()` ç”¨äºè¡¨ç¤ºè°ƒç”¨ `get()` å¯ä»¥è·å–çš„ `T` çš„å®ä¾‹æ˜¯å¦å·²ç»æ„é€ å¥½äº†ã€‚

å…‰çœ‹ `AwareSupplier` è¿™ä¸ªæ¥å£è¿˜å¾—ä¸åˆ°å®Œæ•´çš„ç­”æ¡ˆï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„å®ç°ã€‚

æˆ‘å®šä¹‰äº†ä¸¤ä¸ªå®ç°ç±» `SelfSupplier` å’Œ `AwareMemoizeSupplier`ï¼Œéƒ½å®šä¹‰åœ¨ `Suppliers` å†…éƒ¨ã€‚

```Java
private static class SelfSupplier<T> implements AwareSupplier<T> {
    private final T goods;

    SelfSupplier(@NotNull T goods) {
        this.goods = goods;
    }

    @Override
    public boolean isGoodsHere() {
        return true;
    }

    @Override
    public T get() {
        return goods;
    }
}
```

å¯ä»¥çœ‹åˆ° `SelfSupplier` çš„ `isHere()` æ–¹æ³•æ°¸è¿œè¿”å› `true`ï¼Œè€Œ `get()` æ–¹æ³•è¿”å›å®ä¾‹æ˜¯åœ¨æ„é€  `SelfSupplier`æ—¶ç›´æ¥ä¼ å…¥çš„ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™æ ·çš„å®ç°æ˜¯ç”¨åœ¨æ„é€ æ–°åˆ›å»ºçš„å®ä½“æ—¶ã€‚

----

```java
private static class AwareMemoizeSupplier<T> implements AwareSupplier<T> {
    private final AtomicReference<T> value = new AtomicReference<>();
    private final Supplier<T> supplier;
    private boolean callInnerGet = false;

    AwareMemoizeSupplier(@NotNull Supplier<T> supplier) {
        this.supplier = supplier;
    }

    @Override
    public boolean isHere() {
        return callInnerGet;
    }

    @Override
    public T get() {
        T val = value.get();
        if (val == null) {
            synchronized (value) {
                val = value.get();
                if (val == null) {
                    val = supplier.get();
                    callInnerGet = true;
                    value.set(val);
                }
            }
        }
        return val;
    }
}
```

ä¸`SelfSupplier` ä¸åŒçš„æ˜¯ï¼Œ `AwareMemoizeSupplier` çš„æ„é€ å‡½æ•°çš„å…¥å‚æ˜¯ `Supplier` å¹¶ä¸”å¤šäº†ä¸¤ä¸ªç§æœ‰å˜é‡ï¼Œä¸€ä¸ªç”¨æ¥æ ‡è®°æ˜¯å¦è°ƒç”¨è¿‡`Supplier` çš„ `get()` æ–¹æ³•ï¼Œä¸€ä¸ªç”¨æ¥ç¼“å­˜ `get()` æ–¹æ³•è¿”å›çš„ç»“æœã€‚è¿™æ ·å°±å¯ä»¥è§£å†³ä¸Šé¢çš„ç–‘é—®äº†ã€‚åœ¨è°ƒç”¨ `AwareMemoizeSupplier` çš„ `get()` æ–¹æ³•æ—¶ï¼Œä¼šå…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼Œè·å–ä¸åˆ°æ‰çœŸæ­£è°ƒç”¨ `Supplier` çš„ `get()` æ–¹æ³•å»è·å–ï¼Œå¹¶ä¸”ä¼šå°±æ ‡è®°å˜é‡è®¾ç½®ä¸º `true`ã€‚
è¿™é‡Œè¿˜åŠ äº† `synchronized` ä¸»è¦è€ƒè™‘åˆ°é€šç”¨æ€§ï¼Œå¦‚æœç¡®å®šä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜å¯ä»¥å»æ‰ã€‚

#### å‘½åçš„æ¥ç”±

`AwareSupplier` æ˜¯æƒ³è¡¨è¾¾å…·æœ‰æ„ŸçŸ¥èƒ½åŠ›çš„ `Supplier`ã€‚

`AwareMemoizeSupplier`æ˜¯æƒ³è¡¨è¾¾å…·æœ‰æ„ŸçŸ¥èƒ½åŠ›ä¸”æ‹¥æœ‰è®°å¿†çš„ `Supplier`ã€‚

`SelfSupplier`æ˜¯æƒ³è¡¨è¾¾ä¸€ç§ç‰¹æ®Šçš„ã€å¯ä»¥æä¾›è‡ªæˆ‘è·å–èƒ½åŠ›çš„ `Supplier`ã€‚

å¦‚æœä½ æƒ³åˆ°æ›´å¥½çš„å‘½åï¼Œè¯·åŠæ—¶å‘Šè¯‰æˆ‘ï¼Œæˆ–è€…ç›´æ¥æMRã€‚